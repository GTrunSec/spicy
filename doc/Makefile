# Minimal makefile for Sphinx documentation
#

# You can set these variables from the command line.
SPHINXOPTS    = -W --keep-going -n
SPHINXBUILD   = sphinx-build
SPHINXPROJ    = Spicy
BUILDDIR      = $(PWD)/../build
SOURCEDIR     = $(BUILDDIR)/doc-root
DESTDIR       = $(BUILDDIR)/html

AUTOGEN       = $(BUILDDIR)/html/autogen
SPICYDOC      = $(BUILDDIR)/bin/spicy-doc
SPICYDTR      = ./scripts/spicy-doc-to-rst

# Include these namespaces into the autogenerated type reference.
SPICY_TYPES   = address,bitfield,bool,bytes,enum,exception,integer,list,port,real,regexp,sink,stream,string,struct,tuple,unit,vector

all: html

spicy-lib: $(AUTOGEN)/spicy-functions.spicy $(AUTOGEN)/spicy-types.spicy $(AUTOGEN)/filter-types.spicy $(AUTOGEN)/zeek-functions.spicy

$(AUTOGEN)/spicy-functions.spicy : ../spicy/lib/spicy.spicy scripts/autogen-spicy-lib Makefile
	scripts/autogen-spicy-lib functions spicy <../spicy/lib/spicy.spicy >$(AUTOGEN)/spicy-functions.spicy

$(AUTOGEN)/spicy-types.spicy : ../spicy/lib/spicy.spicy scripts/autogen-spicy-lib Makefile
	scripts/autogen-spicy-lib types spicy <../spicy/lib/spicy.spicy >$(AUTOGEN)/spicy-types.spicy

$(AUTOGEN)/filter-types.spicy : ../spicy/lib/filter.spicy scripts/autogen-spicy-lib Makefile
	scripts/autogen-spicy-lib types spicy <../spicy/lib/filter.spicy >$(AUTOGEN)/filter-types.spicy

$(AUTOGEN)/zeek-functions.spicy : ../zeek/plugin/spicy/zeek.spicy scripts/autogen-spicy-lib Makefile
	scripts/autogen-spicy-lib functions zeek <../zeek/plugin/spicy/zeek.spicy >$(AUTOGEN)/zeek-functions.spicy

update-autogen: clean
	@UPDATE_SPICY_CODE=1 $(MAKE)

update-operators:
	rm -f $(AUTOGEN)/.timestamp && $(MAKE) $(AUTOGEN)/.timestamp

clean:
	rm -rf $(DESTDIR)
	rm -rf $(AUTOGEN)

html: Makefile $(AUTOGEN)/.timestamp spicy-lib
	@rm -f "$(BUILDDIR)/doc-root" && ln -s "../doc" "$(BUILDDIR)/doc-root"
	@  # The RTD theme might be producing RemovedInSphinx30Warning
	@PYTHONWARNINGS="ignore" SPICY_BUILD_DIRECTORY=$(BUILDDIR) $(SPHINXBUILD) -M html "$(SOURCEDIR)" "$(DESTDIR)" $(SPHINXOPTS) $(O)
	@echo Built documentation in $(DESTDIR)/html/index.html

$(AUTOGEN)/.timestamp: $(SPICYDOC) $(SPICYDTR)
	@echo Auto-generating reference documentation ...
	@$(SPICYDOC) | $(SPICYDTR) -t $(SPICY_TYPES) -d $(AUTOGEN)/types
	@touch $(AUTOGEN)/.timestamp

.PHONY: help Makefile
